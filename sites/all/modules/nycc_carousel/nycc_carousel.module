<?php

// new sql
// rely on image cache?

function nycc_carousel_theme($existing, $type, $theme, $path) {
  return array(
    'nycc_carousel' => array(
      'template' => 'nycc-carousel',
      'variables' => array('slides' => array()),
    ),
  );
}

function nycc_carousel_nycc_carousel($variables) {
  return theme('nycc_carousel');
}

function nycc_carousel_block_info() {
  $blocks['nycc_carousel'] = array(
    'info' => t('NYCC Carousel'),
  );
  return $blocks;
}

function nycc_carousel_block_view($delta = '') {
  $block = array();

  switch ($delta) {
    case 'nycc_carousel':
      $block['subject'] = t('NYCC Carousel');
      $block['content'] = theme('nycc_carousel');
      break;
  }
  return $block;
}

function nycc_carousel_process_nycc_carousel(&$variables) {
  $variables['slides'] = _nycc_carousel_get_slides();
}

function _nycc_carousel_get_slides() {
  $slides = array();
  
  $filesdir = variable_get('file_public_path', conf_path() . '/files');
  
  $sql =<<<EOS
    SELECT n.nid, n.title, d.field_date_value, f.filename, b.body_value AS body
    FROM {node} n, {field_data_body} b, {field_data_field_date} d, {field_data_field_image_cache} i, {files} f, {field_data_field_carousel_order} co 
    WHERE co.entity_id = n.nid AND co.revision_id = n.vid AND n.nid = d.entity_id AND n.vid = d.revision_id AND n.nid = b.entity_id AND n.vid = b.revision_id AND n.nid = i.entity_id AND n.vid = i.revision_id AND f.fid = i.field_image_cache_fid AND ((n.promote=1) AND ((n.type='event') OR (n.type='page')) AND (n.status <> 0)) 
    ORDER BY field_carousel_order_value ASC, field_date_value ASC 
    LIMIT 4
EOS;
  
  $results = db_query($sql);
  foreach ($results as $r) {
    $body = strip_tags($r->body);
    if (strlen($body) >= 90)
      $body = substr($body,0,87) .'...';
    $imgpath = $filesdir . "/imagecache/home_page_top_banner/". $r->filename;
    $thumbpath = $filesdir ."/imagecache/home_page_top_thumbnail/". $r->filename;
    $nodepath = "/node/". $r->nid;
    $date = $r->field_date_value;
    $title = $r->title;
    
    $slides[] = array('body' => $body, 'imgpath' => $imgpath, 'thumbpath' => $thumbpath, 'nodepath' => $nodepath, 'title' => $title, 'date' => $date, );
  } // for

  /*
  $slides[] = array('title' => 'xxxxAll-Class Ride 2015', 'src' => 'http://nycc.org/sites/default/files/imagecache/home_page_top_banner/071815-allClassRide.jpg', 'caption' => 'The NYCC 2015 All-Class Ride - Join us for the ride of the year!');
  
  $slides[] = array('title' => 'Escape New York 2015', 'src' => 'http://nycc.org/sites/default/files/imagecache/home_page_top_banner/ENY-Logo2015-2.png', 'caption' => 'This fall classic offers four scenic, well marked routes  -   25, 50, 65 or 100 miles – all beginning and ending at Sakura Park in Manhattan.   All offer picture-postcard views of the Hudson River and Palisades as you cross the George Washington Bridge and ride the serene roads of Bergen and Rockland Counties.');
  
  $slides[] = array('title' => 'Cycling Skills Active Workshop', 'src' => 'http://nycc.org/sites/default/files/imagecache/home_page_top_banner/nycc-manuel-bikes-banner.jpg', 'caption' => "Calling ALL NYCC cyclists! Come one, come all... A riders, B riders, C riders! Join us for a totally \"classless\" skills session. Improve your handing skills... practice navigating the GWB hairpin turn... have a go at \"bunny hopping\"... take part in flat changing clinic... join a \"race\" where the slowest rider wins... and much, much more! It will be a fun and informative morning. Bring everything you'd normally bring on a ride, tubes, inflation device, fluids, etc. ");
  
  $slides[] = array('title' => 'NYCC 2015 Ice Cream Social', 'src' => 'http://nycc.org/sites/default/files/imagecache/home_page_top_banner/060515-iceCreamSocial.png', 'caption' => 'Please join us for ice cream as we take in the beautiful NYC skyline with front row seats from Pier 1 at Brooklyn Bridge Park.  You bring the talk, The Brooklyn Ice Cream Factory will bring the ice cream and the city will bring the views!!  (and yes, I’ve already asked Mother Nature to bring the weather – the pleasant kind.  She’s thinking about it). ');
  */
  return $slides;
}


